//! ludorum-player-cbr 0.0.1

(function(t){"use strict";this["ludorum-player-cbr"]=t(this.base,this.Sermat,this.ludorum,this.ludorum_risky)}).call(this,function t(e,n,r){"use strict";var s,a,i,o,u,c=e.declare,l=e.objects.unimplemented,_=e.raise,f=(e.raiseIf,e.Randomness),h=e.Iterable,m=e.iterable,p=e.Future,d={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:t,__dependencies__:[e,n,r],__SERMAT__:{include:[e,r]},dbs:{},games:{},training:{},utils:{}},y=d.dbs,g=d.games,v=d.training,b=d.utils,E=d.Case=c({constructor:function(t){this.count=+t.count||1,this.ply=+t.ply,this.features=t.features,this.actions=t.actions,this.results=t.results,this.id=t.id||this.identifier()},addResult:function(t){var e;for(var n in t)e=t[n],Array.isArray(e)&&3===e.length?(this.results[n][0]+=t[n][0],this.results[n][1]+=t[n][1],this.results[n][2]+=t[n][2]):"number"==typeof e?this.results[n][e>0?0:0===e?1:2]++:_("Invalid result (",e,")!");return this.count=(this.count||0)+1,this},merge:function(t){this.ply=(this.ply*this.count+t.ply*t.count)/(this.count+t.count),this.count+=t.count,this.addResult(t.result)},identifier:function(){return this.features.join("|")+JSON.stringify(this.actions)},record:function(t){var e;for(e in(t=t||{}).id=this.id,t.ply=this.ply,t.count=this.count,this.features.forEach(function(e,n){t["f"+n]=e}),this.actions)t["a_"+e]=JSON.stringify(this.actions[e]);for(e in this.results)t["won_"+e]=this.results[e][0],t["tied_"+e]=this.results[e][1],t["lost_"+e]=this.results[e][2];return t},"static fromRecord":function(t){var e=[],n={},r={};for(var s in t)if("f"===s[0])e[+s.substr(1)]=t[s];else if("a_"===s.substr(0,2))n[s.substr(2)]=JSON.parse(t[s]);else if("won_"===s.substr(0,4)){var a=s.substr(4);r[a]=[t["won_"+a],t["tied_"+a],t["lost_"+a]]}return new this({count:t.count,ply:t.ply,features:e,actions:n,results:r})},"static actionsFromMoves":function(t,e){return m(t).map(function(t){return[t,e&&e.hasOwnProperty(t)?e[t]:null]}).toObject()},"static emptyResults":function(t){return m(t).map(function(t){return[t,[0,0,0]]}).toObject()},"static __SERMAT__":{identifier:"Case",serializer:function(t){return[{id:t.id,count:t.count,ply:t.ply,features:t.features,actions:t.actions,results:t.results}]}}}),A=d.CaseBase=c({constructor:function(t){this.random=t&&t.random||f.DEFAULT},init:l("CaseBase","init(game, player)"),addCase:l("CaseBase","addCase(_case)"),cases:l("CaseBase","cases(filters)"),distance:function(t,n){return e.Iterable.zip(t,n).mapApply(function(t,e){return null===t||isNaN(t)||null===e||isNaN(e)?0:Math.abs(t-e)}).sum()},nn:function(t,e){var n=this;return e=m(e),m(this.cases()).map(function(t){var r=e.map(function(e){return n.distance(t.features,e.features)}).min();return[t,r]}).sorted(function(t,e){return t[1]-e[1]}).take(+t).toArray()}}),N=d.CaseBasedPlayer=e.declare(r.Player,{constructor:function(t){r.Player.call(this,t),this.k=t&&t.k||20,this.caseBase=t&&t.caseBase||new O,this.caseBase.init(this.game,this)},casesFromGame:e.objects.unimplemented("CaseBasedPlayer","casesFromGame(game, ply, moves)"),newCase:function(t,e,n,r){return(r=r||{}).hasOwnProperty("ply")||(r.ply=+e),r.hasOwnProperty("actions")||(r.actions=E.actionsFromMoves(t.players,n)),r.hasOwnProperty("results")||(r.results=E.emptyResults(t.players)),new E(r)},addMatch:function(t,e){var n=this;e.retainThreshold;return t.run().then(function(){var e=t.result(),r=m(t.history).filter(function(t){return!!t.moves}).map(function(t,e){return n.casesFromGame(t.state,e,t.moves)}).flatten().map(function(t){return t.addResult(e)});return n.caseBase.addCase(r.toArray()),t})},addMatches:function(t,e){var n=this,r=0,s=0;return e.logger&&(s=setInterval(function(){e.logger.info("Added "+r+" matches.")},e.logTime||3e4)),p.sequence(t,function(t){return r++,n.addMatch(t,e)}).then(function(t){return e.logger&&e.logger.info("Added "+r+" matches."),clearInterval(s),t})},actionEvaluations:function(t,n,r){var s=r&&+r.k||this.k,a=e.iterable(t.moves()[n]).map(function(t){return[JSON.stringify(t),[t,0]]}).toObject(),i=this.caseBase.nn(s,this.casesFromGame(t));return m(i).forEachApply(function(t,e){var r,s=a[JSON.stringify(t.actions[n])],i=t.results[n];s&&(r=t.count/(10+t.count)*(i[0]+i[2]&&(i[0]-i[2])/(i[0]+i[2]))*(1/(1+e)),isNaN(r)&&_("Action evaluation is NaN for case: ",JSON.stringify(t)," (distance= ",e,")!"),s[1]+=r)}),Object.values(a)},gameEvaluation:function(t,n,r){var s=r&&+r.k||this.k,a=(e.iterable(t.moves()[n]).map(function(t){return[JSON.stringify(t),[t,0]]}).toObject(),cb.nn(s,t,n));return m(a).map(function(t,e){return(t.results[n][0]-t.results[n][2])/(1+e)}).sum()},checkMoves:function(t,e){var n=[[],[]];return this.movesFor(t,e).forEach(function(r){var s=t.perform(r,e).result();s?s[e]>0&&n[0].push(r):n[1].push(r)}),n},decision:function(t,e){var n=this.checkMoves(t,e);if(n[0].length>0)return this.random.choice(n[0]);if(n[1].length<2)return 1===n[1].length?n[1][0]:this.random.choice(this.movesFor(t,e));var r=m(n[1]).map(function(t){return[t+"",[t,0]]}).toObject();this.actionEvaluations(t,e,{k:this.k}).forEach(function(t){var e=r[t[0]+""];e&&(e[1]+=t[1])});var s=1/0,a=Object.values(r).filter(function(t){return s=Math.min(s,t[1]),t[1]>0}),i=Object.values(r).filter(function(t){return t[1]<=0}).map(function(t){return[t[0],t[1]-s]});return a.length>1?this.random.weightedChoice(this.random.normalizeWeights(a)):1===a.length?a[0][0]:this.random.weightedChoice(this.random.normalizeWeights(i))}}),O=y.MemoryCaseBase=c(A,{constructor:function(t){A.call(this,t),this.__cases__=[],this.__index__={},t&&t.__cases__&&t.__cases__.forEach(this.addCase.bind(this))},init:function(t,e){},cases:function(){return e.iterable(this.__cases__)},addCase:function(t){if(t instanceof E){var e=t.identifier();if(this.__index__.hasOwnProperty(e)){this.__cases__[this.__index__[e]].merge(t)}else{var n=this.__cases__.push(t)-1;this.__index__[e]=n}}else m(t).forEach(this.addCase.bind(this))},"static __SERMAT__":{identifier:"MemoryCaseBase",serializer:function(t){return[{__cases__:t.__cases__}]}}});return y.SQLiteCaseBase=c(A,{constructor:function(t){A.call(this,t),this.__setupDatabase__(t)},MAX_CASES_PER_UPSERT:30,__setupDatabase__:function(t){var e=this.Database||require("better-sqlite3");if(t.db instanceof e)this.__db__=t.db;else{var n="string"==typeof t.db?t.db:"./cbr-test.sqlite";this.__db__=new e(n),this.__db__.pragma("journal_mode = OFF"),this.__db__.pragma("cache_size = -128000"),this.__db__.pragma('encoding = "UTF-8"')}this.__tableName__=t.tableName},__createTable__:function(t,e){var n=Object.keys(e.actions).map(function(t){return"a_"+t+" TEXT"}).join(", "),r=Object.keys(e.results).map(function(t){return"won_"+t+" INTEGER, tied_"+t+" INTEGER, lost_"+t+" INTEGER"}).join(", "),s=e.features.map(function(t,e){return"f"+e+" INTEGER"}).join(", ");return this.__runSQL__("CREATE TABLE IF NOT EXISTS "+t+"(id TEXT PRIMARY KEY, count INTEGER, ply REAL, "+n+", "+r+", "+s+")")},__runSQL__:function(t){var e=Array.prototype.slice.call(arguments,1);try{var n=this.__db__.prepare(t);return n.run.apply(n,e)}catch(n){throw new Error("Error executing `"+t+"` "+JSON.stringify(e)+"!")}},__getSQL__:function(t){var e=Array.prototype.slice.call(arguments,1);try{var n=this.__db__.prepare(t);return n.all.apply(n,e)}catch(n){throw new Error("Error querying `"+t+"` "+JSON.stringify(e)+"!")}},init:function(t,e){this.__tableName__=this.__tableName__||"CB_"+t.name;var n=e.casesFromGame(t,0,t.moves())[0];this.__createTable__(this.__tableName__,n)},addCase:function(t){if(Array.isArray(t)||(t=[t]),!(t.length<1)){var e=this,n=e.MAX_CASES_PER_UPSERT,r=t[0].record(),s=Object.keys(r),a=s.filter(function(t){return/^(won_|tied_|lost_)/.test(t)}),i="INSERT INTO "+this.__tableName__+" ("+s.join(",")+") VALUES ",o="("+h.repeat("?",s.length).join(",")+")",u=" ON CONFLICT(id) DO UPDATE SET count = count + 1, ply = (ply * count + excluded.ply) / (count + 1),  "+a.map(function(t){return t+" = "+t+" + excluded."+t}).join(", ");m(t).slices(n).forEach(function(t){var n=i+h.repeat(o,t.length).join(",")+u;e.__runSQL__(n,m(t).map(function(t){var e=t.record();return s.map(function(t){return e[t]})}).flatten().toArray())})}},cases:function(){return this.__getSQL__("SELECT * FROM "+this.__tableName__).map(E.fromRecord.bind(E))},__nn_sql__:function(t,e){var n=e.map(function(t){return t.features.map(function(t,e){return null===t||isNaN(t)?"0":"abs(ifnull(f"+e+"-("+t+"),0))"}).join("+")});return"SELECT *, "+(n.length>1?n[0]:"min("+n.join(", ")+")")+" AS distance FROM "+this.__tableName__+" ORDER BY distance ASC LIMIT "+t},nn:function(t,e){var n=this.__nn_sql__(t,e);return this.__db__.prepare(n).all().map(function(t){return[E.fromRecord(t),t.distance]})}}),g.TicTacToe=(s=function(t){return("string"==typeof t?t:t.board).split("").map(function(t){return"X"===t?1:"O"===t?-1:0})},a=c(N,{constructor:function(t){N.call(this,t)},game:new r.games.TicTacToe,features:s,casesFromGame:function(t,e,n){var r=n?n.hasOwnProperty("Xs")?n.Xs:n.Os:"?";return[this.newCase(t,e,n,{id:t.board+r,features:this.features(t)})]}}),i=[[0,1,2,3,4,5,6,7,8],[2,1,0,5,4,3,8,7,6],[6,7,8,3,4,5,0,1,2],[6,3,0,7,4,1,8,5,2],[2,5,8,1,4,7,0,3,6],[8,7,6,5,4,3,2,1,0],[8,5,2,7,4,1,6,3,0],[0,3,6,1,4,7,2,5,8]],o=function(t){var e="string"==typeof t?t:t.board,n=i.map(function(t){return t.map(function(t){return e.charAt(t)}).join("")});return(n=Array.from(new Set(n))).sort(),n},u=c(N,{constructor:function(t){N.call(this,t)},game:new r.games.TicTacToe,features:s,MAPPINGS:i,casesFromGame:function(t,e,n){var r=this,s=t.board.split(""),a=t.activePlayer();return n&&(s[n[a]]="!"),o(s.join("")).map(function(t){var e=t.indexOf("!");return t.replace("!","_")+e}).map(function(s){return n&&(n[a]=+s.substr(9)),r.newCase(t,e,n,{features:r.features(s.substr(0,9))})})}}),{directFeatures:s,DirectCBPlayer:a,MAPPINGS:i,equivalent:o,EquivalenceCBPlayer:u}),v.populate=function(t,e){var n=(e=e||{}).game||t.game,s=isNaN(e.n)?100:+e.n,a=e.trainer||t,i=e.opponents||[a];Array.isArray(i)||(i=[i]);var o=new r.tournaments.Measurement(n,a,i,1).__matches__().toArray();return t.addMatches(h.range(Math.ceil(s/o.length)).product(o).mapApply(function(t,e){return new r.Match(n,e.players)}),e)},b.assess=function(t,n){var s=n.opponents||n.opponent?[n.opponent]:new r.players.RandomPlayer,a=n.game||t.game,i=m(s).map(function(t){return[t.name,m(a.players).map(function(t){return[t,[0,0,0]]}).toObject()]}).toObject(),o=n&&+n.assessCount||300,u=0,c=0,l=n.logger;return l&&(c=setInterval(function(){l.info("Assessment finished "+u+" matches.")},n.logTime||3e4)),e.Future.sequence(e.Iterable.range(o).product(s),function(n){var s=n[1],o=e.Iterable.repeat(s,a.players.length).toArray(),c=n[0]%a.players.length,l=a.players[c];o[c]=t;var _=new r.Match(a,o);return _.run().then(function(){var t=_.result()[l];i[s.name][l][t>0?0:t<0?2:1]++,u++})}).then(function(){return clearInterval(c),l&&l.info("Assessment finished "+u+" matches."),i})},b.populateAndAssess=function(t,n){function s(){return new r.players.RandomPlayer({name:"RandomPlayer"})}var a=n.name||t.name,i=n.logger,o=n.game||t.game;return i&&i.info("Assessing "+o.name+" with "+a+"."),i.info("Base line evaluation for "+o.name+" with a random player."),e.Future.sequence(n.opponents||[s()],function(t){return b.assess(s(),{game:o,opponent:t,assessCount:n.assessCount||80,logger:i}).then(function(e){i.info("Against "+t.name+": "+JSON.stringify(e))})}).then(function(){return v.populate(t,{n:n.populateCount||1e3,trainer:n.trainer||s(),logger:i})}).then(function(){return i.info("Evaluating player for "+o.name+" trained with "+a+"."),e.Future.sequence(n.opponents||[s()],function(e){return b.assess(t,{game:o,opponent:e,assessCount:n.assessCount||80,logger:i}).then(function(t){i.info("Against "+e.name+": "+JSON.stringify(t))})})})},d});
//# sourceMappingURL=ludorum-player-cbr-tag.min.js.map