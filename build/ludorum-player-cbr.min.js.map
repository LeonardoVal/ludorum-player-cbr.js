{"version":3,"sources":["../src/__prologue__.js","../src/games/tictactoe.js","../src/Case.js","../src/CaseBase.js","../src/CaseBasedPlayer.js","../src/dbs/MemoryCaseBase.js","../src/__epilogue__.js","../src/dbs/SQLiteCaseBase.js","../src/training.js","../src/utils.js"],"names":["__init__","base","Sermat","ludorum","directFeatures","DirectCBPlayer","MAPPINGS","equivalent","EquivalenceCBPlayer","declare","unimplemented","objects","raise","Randomness","raiseIf","Iterable","iterable","Future","exports","__package__","__name__","__dependencies__","__SERMAT__","include","dbs","games","training","utils","Case","constructor","props","this","count","ply","features","actions","results","id","identifier","addResult","result","r","p","Array","isArray","length","merge","_case","join","JSON","stringify","record","obj","forEach","f","i","static fromRecord","k","substr","parse","static actionsFromMoves","players","moves","map","hasOwnProperty","toObject","static emptyResults","static __SERMAT__","serializer","CaseBase","params","random","DEFAULT","init","addCase","cases","distance","features1","features2","zip","mapApply","f1","f2","isNaN","Math","abs","sum","nn","cb","d","c","min","sorted","c1","c2","take","toArray","CaseBasedPlayer","Player","call","caseBase","MemoryCaseBase","game","casesFromGame","newCase","actionsFromMoves","emptyResults","addMatch","match","options","cbrPlayer","retainThreshold","run","then","history","filter","entry","state","flatten","addMatches","matches","matchCount","intervalId","logger","setInterval","info","logTime","sequence","clearInterval","actionEvaluations","role","move","knn","forEachApply","ev","m","Object","values","gameEvaluation","checkMoves","movesFor","perform","push","decision","choice","action","t","minEval","Infinity","positiveActions","negativeActions","weightedChoice","normalizeWeights","__cases__","__index__","bind","player","SQLiteCaseBase","__setupDatabase__","MAX_CASES_PER_UPSERT","Database","require","db","__db__","dbName","pragma","__tableName__","tableName","__createTable__","reference","actionColumns","keys","resultColumns","featureColumns","_","__runSQL__","sql","args","prototype","slice","arguments","stmt","prepare","apply","err","Error","__getSQL__","all","name","_cases","fields","resultFields","test","repeat","slices","fromRecord","TicTacToe","board","split","chr","Xs","Os","maps","mapping","charAt","from","Set","sort","activePlayer","b","indexOf","replace","populate","cbPlayer","n","trainer","opponents","matchups","tournaments","Measurement","__matches__","range","ceil","product","Match","assess","opponent","RandomPlayer","evaluation","assessCount","finishedMatchesCount","tuple","matchPlayers","playerIndex","playerRole","populateAndAssess","populateCount"],"mappings":";;yTAEA,SAASA,EAASC,EAAMC,EAAQC,GAAW,aAE1C,ICEIC,EAOAC,EAwBAC,EAWAC,EAYAC,EDxDAC,EAAUR,EAAKQ,QAClBC,EAAgBT,EAAKU,QAAQD,cAC7BE,EAAQX,EAAKW,MAEbC,GADUZ,EAAKa,QACFb,EAAKY,YAClBE,EAAWd,EAAKc,SAChBC,EAAWf,EAAKe,SAChBC,EAAShB,EAAKgB,OAGXC,GACFC,YAAa,qBACbC,SAAU,qBACVpB,SAAUA,EACVqB,kBAAmBpB,EAAMC,EAAQC,GACjCmB,YAAcC,SAAUtB,EAAME,IAE9BqB,OACAC,SACAC,YACAC,UAEDH,EAAMN,EAAQM,IACdC,EAAQP,EAAQO,MAChBC,EAAWR,EAAQQ,SACnBC,EAAQT,EAAQS,MEzBdC,EAAOV,EAAQU,KAAOnB,GAUzBoB,YAAa,SAAcC,GAC1BC,KAAKC,OAASF,EAAME,OAAS,EAC7BD,KAAKE,KAAOH,EAAMG,IAClBF,KAAKG,SAAWJ,EAAMI,SACtBH,KAAKI,QAAUL,EAAMK,QACrBJ,KAAKK,QAAUN,EAAMM,QACrBL,KAAKM,GAAKP,EAAMO,IAAMN,KAAKO,cAK5BC,UAAW,SAAmBC,GAC7B,IAAIC,EACJ,IAAK,IAAIC,KAAKF,EACbC,EAAID,EAAOE,GACPC,MAAMC,QAAQH,IAAmB,IAAbA,EAAEI,QACzBd,KAAKK,QAAQM,GAAG,IAAMF,EAAOE,GAAG,GAChCX,KAAKK,QAAQM,GAAG,IAAMF,EAAOE,GAAG,GAChCX,KAAKK,QAAQM,GAAG,IAAMF,EAAOE,GAAG,IACT,iBAAND,EACjBV,KAAKK,QAAQM,GAAGD,EAAI,EAAI,EAAU,IAANA,EAAU,EAAI,KAE1C7B,EAAK,mBAAqB6B,EAAG,MAI/B,OADAV,KAAKC,OAASD,KAAKC,OAAS,GAAK,EAC1BD,MAKRe,MAAO,SAAeC,GACrBhB,KAAKE,KAAOF,KAAKE,IAAMF,KAAKC,MAAQe,EAAMd,IAAMc,EAAMf,QAAUD,KAAKC,MAAQe,EAAMf,OACnFD,KAAKC,OAASe,EAAMf,MACpBD,KAAKQ,UAAUQ,EAAMP,SAOtBF,WAAY,WACX,OAAOP,KAAKG,SAASc,KAAI,KAAQC,KAAKC,UAAUnB,KAAKI,UAKtDgB,OAAQ,SAAgBC,GAEvB,IAAIV,EAOJ,IAAKA,KARLU,EAAMA,OAEFf,GAAKN,KAAKM,GACde,EAAInB,IAAMF,KAAKE,IACfmB,EAAIpB,MAAQD,KAAKC,MACjBD,KAAKG,SAASmB,QAAQ,SAAUC,EAAGC,GAClCH,EAAG,IAAMG,GAAKD,IAELvB,KAAKI,QACdiB,EAAG,KAAOV,GAAKO,KAAKC,UAAUnB,KAAKI,QAAQO,IAE5C,IAAKA,KAAKX,KAAKK,QACdgB,EAAG,OAASV,GAAKX,KAAKK,QAAQM,GAAG,GACjCU,EAAG,QAAUV,GAAKX,KAAKK,QAAQM,GAAG,GAClCU,EAAG,QAAUV,GAAKX,KAAKK,QAAQM,GAAG,GAEnC,OAAOU,GAKRI,oBAAqB,SAAoBL,GACxC,IAAIjB,KACHC,KACAC,KACD,IAAK,IAAIqB,KAAKN,EACb,GAAa,MAATM,EAAE,GACLvB,GAAUuB,EAAEC,OAAO,IAAMP,EAAOM,QAC1B,GAAuB,OAAnBA,EAAEC,OAAO,EAAG,GACtBvB,EAAQsB,EAAEC,OAAO,IAAMT,KAAKU,MAAMR,EAAOM,SACnC,GAAuB,SAAnBA,EAAEC,OAAO,EAAG,GAAe,CACrC,IAAIhB,EAAIe,EAAEC,OAAO,GACjBtB,EAAQM,IAAMS,EAAM,OAAST,GAAIS,EAAM,QAAUT,GAAIS,EAAM,QAAUT,IAGvE,OAAO,IAAIX,MACVC,MAAOmB,EAAOnB,MACdC,IAAKkB,EAAOlB,IACZC,SAAUA,EACVC,QAASA,EACTC,QAASA,KAQXwB,0BAA2B,SAAoBC,EAASC,GACvD,OAAO9C,EAAS6C,GAASE,IAAI,SAAUrB,GACtC,OAAQA,EAAGoB,GAASA,EAAME,eAAetB,GAAKoB,EAAMpB,GAAK,QACvDuB,YAKJC,sBAAuB,SAAsBL,GAC5C,OAAO7C,EAAS6C,GAASE,IAAI,SAAUrB,GACtC,OAAQA,GAAI,EAAG,EAAG,MAChBuB,YAKJE,qBACC7B,WAAY,OACZ8B,WAAY,SAAwBhB,GACnC,QACCf,GAAIe,EAAIf,GACRL,MAAOoB,EAAIpB,MACXC,IAAKmB,EAAInB,IACTC,SAAUkB,EAAIlB,SACdC,QAASiB,EAAIjB,QACbC,QAASgB,EAAIhB,cCnIbiC,EAAWnD,EAAQmD,SAAW5D,GACjCoB,YAAa,SAAkByC,GAC9BvC,KAAKwC,OAASD,GAAUA,EAAOC,QAAU1D,EAAW2D,SAQrDC,KAAM/D,EAAa,WAAa,sBAIhCgE,QAAShE,EAAa,WAAa,kBAKnCiE,MAAOjE,EAAa,WAAa,kBAOjCkE,SAAU,SAAkBC,EAAWC,GACtC,OAAO7E,EAAKc,SAASgE,IAAIF,EAAWC,GAAWE,SAAS,SAAUC,EAAIC,GACrE,OAAW,OAAPD,GAAgBE,MAAMF,IAAc,OAAPC,GAAgBC,MAAMD,GAG/C,EAFAE,KAAKC,IAAIJ,EAAKC,KAIpBI,OAKJC,GAAI,SAAY9B,EAAGkB,GAClB,IAAIa,EAAKzD,KAET,OADA4C,EAAQ3D,EAAS2D,GACV3D,EAASe,KAAK4C,SAASZ,IAAI,SAAUhB,GAC1C,IAAI0C,EAAId,EAAMZ,IAAI,SAAU2B,GAC3B,OAAOF,EAAGZ,SAAS7B,EAAMb,SAAUwD,EAAExD,YACnCyD,MACH,OAAQ5C,EAAO0C,KACbG,OAAO,SAAUC,EAAIC,GACvB,OAAOD,EAAG,GAAKC,EAAG,KAChBC,MAAMtC,GAAGuC,aCjDXC,EAAkB/E,EAAQ+E,gBAAkBhG,EAAKQ,QAAQN,EAAQ+F,QAGpErE,YAAa,SAAyByC,GACrCnE,EAAQ+F,OAAOC,KAAKpE,KAAMuC,GAC1BvC,KAAK0B,EAAIa,GAAUA,EAAOb,GAAK,GAC/B1B,KAAKqE,SAAW9B,GAAUA,EAAO8B,UAAY,IAAIC,EACjDtE,KAAKqE,SAAS3B,KAAK1C,KAAKuE,KAAMvE,OAM/BwE,cAAetG,EAAKU,QAAQD,cAAa,kBAAoB,mCAI7D8F,QAAS,SAAiBF,EAAMrE,EAAK6B,EAAOf,GAW3C,OAVAA,EAAQA,OACGiB,eAAc,SACxBjB,EAAMd,KAAOA,GAETc,EAAMiB,eAAc,aACxBjB,EAAMZ,QAAUP,EAAK6E,iBAAiBH,EAAKzC,QAASC,IAEhDf,EAAMiB,eAAc,aACxBjB,EAAMX,QAAUR,EAAK8E,aAAaJ,EAAKzC,UAEjC,IAAIjC,EAAKmB,IAQjB4D,SAAU,SAAkBC,EAAOC,GAClC,IAAIC,EAAY/E,KACI8E,EAAQE,gBAC5B,OAAOH,EAAMI,MAAMC,KAAK,WACvB,IAAIzE,EAASoE,EAAMpE,SAClBmC,EAAQ3D,EAAS4F,EAAMM,SAASC,OAAO,SAAUC,GAChD,QAASA,EAAMtD,QACbC,IAAI,SAAUqD,EAAO7D,GACvB,OAAOuD,EAAUP,cAAca,EAAMC,MAAO9D,EAAG6D,EAAMtD,SACnDwD,UAAUvD,IAAI,SAAUhB,GAC1B,OAAOA,EAAMR,UAAUC,KAGzB,OADAsE,EAAUV,SAAS1B,QAAQC,EAAMqB,WAC1BY,KAOTW,WAAY,SAAoBC,EAASX,GACxC,IAAIC,EAAY/E,KACf0F,EAAa,EACbC,EAAa,EAMd,OALIb,EAAQc,SACXD,EAAaE,YAAY,WACxBf,EAAQc,OAAOE,KAAI,SAAWJ,EAAW,cACvCZ,EAAQiB,SAAW,MAEhB7G,EAAO8G,SAASP,EAAS,SAAUZ,GAEzC,OADAa,IACOX,EAAUH,SAASC,EAAOC,KAC/BI,KAAK,SAAUxE,GAKjB,OAJIoE,EAAQc,QACXd,EAAQc,OAAOE,KAAI,SAAWJ,EAAW,aAE1CO,cAAcN,GACPjF,KASTwF,kBAAmB,SAA2B3B,EAAM4B,EAAMrB,GACzD,IAAIpD,EAAIoD,IAAYA,EAAQpD,GAAK1B,KAAK0B,EACrChB,EAAIxC,EAAKe,SAASsF,EAAKxC,QAAQoE,IAAOnE,IAAI,SAAUoE,GACnD,OAAQlF,KAAKC,UAAUiF,IAAQA,EAAM,MACnClE,WACHmE,EAAMrG,KAAKqE,SAASb,GAAG9B,EAAG1B,KAAKwE,cAAcD,IAiB9C,OAhBAtF,EAASoH,GAAKC,aAAa,SAAUtF,EAAO6B,GAC3C,IAEC0D,EAFGC,EAAI9F,EAAEQ,KAAKC,UAAUH,EAAMZ,QAAQ+F,KACtC1F,EAASO,EAAMX,QAAQ8F,GAEpBK,IAIHD,EAHUvF,EAAMf,OAAS,GAAKe,EAAMf,QAC3BQ,EAAO,GAAKA,EAAO,KACzBA,EAAO,GAAKA,EAAO,KAAOA,EAAO,GAAKA,EAAO,MACxB,GAAK,EAAIoC,IAC7BO,MAAMmD,IACT1H,EAAK,sCAAwCqC,KAAKC,UAAUH,GAC3D,eAAgB6B,EAAU,MAE5B2D,EAAE,IAAMD,KAGHE,OAAOC,OAAOhG,IAOtBiG,eAAgB,SAAwBpC,EAAM4B,EAAMrB,GACnD,IAAIpD,EAAIoD,IAAYA,EAAQpD,GAAK1B,KAAK0B,EAIrC2E,GAHInI,EAAKe,SAASsF,EAAKxC,QAAQoE,IAAOnE,IAAI,SAAUoE,GACnD,OAAQlF,KAAKC,UAAUiF,IAAQA,EAAM,MACnClE,WACGuB,GAAGD,GAAG9B,EAAG6C,EAAM4B,IACtB,OAAOlH,EAASoH,GAAKrE,IAAI,SAAUhB,EAAO6B,GACzC,OAAQ7B,EAAMX,QAAQ8F,GAAM,GAAKnF,EAAMX,QAAQ8F,GAAM,KAAO,EAAItD,KAC9DU,OAQJqD,WAAY,SAAoBrC,EAAM4B,GACrC,IAAIzF,UAUJ,OATAV,KAAK6G,SAAStC,EAAM4B,GAAM7E,QAAQ,SAAU8E,GAC3C,IACC3F,EADW8D,EAAKuC,QAAQV,EAAMD,GACf1F,SACXA,EAEMA,EAAO0F,GAAQ,GACzBzF,EAAE,GAAGqG,KAAKX,GAFV1F,EAAE,GAAGqG,KAAKX,KAKL1F,GASRsG,SAAU,SAAkBzC,EAAM4B,GACjC,IAAIS,EAAa5G,KAAK4G,WAAWrC,EAAM4B,GACvC,GAAIS,EAAW,GAAG9F,OAAS,EAC1B,OAAOd,KAAKwC,OAAOyE,OAAOL,EAAW,IAC/B,GAAIA,EAAW,GAAG9F,OAAS,EACjC,OAA6B,IAAzB8F,EAAW,GAAG9F,OACV8F,EAAW,GAAG,GAEd5G,KAAKwC,OAAOyE,OAAOjH,KAAK6G,SAAStC,EAAM4B,IAGhD,IAAI/F,EAAUnB,EAAS2H,EAAW,IAAI5E,IAAI,SAAUkF,GAClD,OAAQA,EAAO,IAAMA,EAAQ,MAC3BhF,WACJlC,KAAKkG,kBAAkB3B,EAAM4B,GAAQzE,EAAG1B,KAAK0B,IAAKJ,QAAQ,SAAU6F,GACnE,IAAI9B,EAAQjF,EAAQ+G,EAAE,GAAG,IACrB9B,IACHA,EAAM,IAAM8B,EAAE,MAGhB,IAAIC,EAAWC,EAAAA,EACdC,EAAkBb,OAAOC,OAAOtG,GAASgF,OAAO,SAAU+B,GAEzD,OADAC,EAAU/D,KAAKO,IAAIwD,EAASD,EAAE,IACvBA,EAAE,GAAK,IAEfI,EAAkBd,OAAOC,OAAOtG,GAASgF,OAAO,SAAU+B,GACzD,OAAOA,EAAE,IAAM,IACbnF,IAAI,SAAUmF,GAChB,OAAQA,EAAE,GAAIA,EAAE,GAAKC,KAUvB,OAPIE,EAAgBxG,OAAS,EACnBd,KAAKwC,OAAOgF,eAAexH,KAAKwC,OAAOiF,iBAAiBH,IAC5B,IAA3BA,EAAgBxG,OACjBwG,EAAgB,GAAG,GAEnBtH,KAAKwC,OAAOgF,eAAexH,KAAKwC,OAAOiF,iBAAiBF,OCtLhEjD,EAAiB7E,EAAI6E,eAAiB5F,EAAQ4D,GACjDxC,YAAa,SAAwByC,GACpCD,EAAS8B,KAAKpE,KAAMuC,GACpBvC,KAAK0H,aACL1H,KAAK2H,aACDpF,GAAUA,EAAOmF,WACpBnF,EAAOmF,UAAUpG,QAAQtB,KAAK2C,QAAQiF,KAAK5H,QAI7C0C,KAAM,SAAc6B,EAAMsD,KAI1BjF,MAAO,WACN,OAAO1E,EAAKe,SAASe,KAAK0H,YAG3B/E,QAAS,SAAiB3B,GACzB,GAAIA,aAAiBnB,EAAM,CAC1B,IAAIS,EAAKU,EAAMT,aACf,GAAIP,KAAK2H,UAAU1F,eAAe3B,GAAK,CACrBN,KAAK0H,UAAU1H,KAAK2H,UAAUrH,IACpCS,MAAMC,OACX,CACN,IAAIQ,EAAIxB,KAAK0H,UAAUX,KAAK/F,GAAS,EACrChB,KAAK2H,UAAUrH,GAAMkB,QAGtBvC,EAAS+B,GAAOM,QAAQtB,KAAK2C,QAAQiF,KAAK5H,QAM5CoC,qBACC7B,WAAY,iBACZ8B,WAAY,SAAkChB,GAC7C,QACCqG,UAAWrG,EAAIqG,gBC1ClB,OCGDjI,EAAIqI,eAAiBpJ,EAAQ4D,GAG5BxC,YAAa,SAAwByC,GACpCD,EAAS8B,KAAKpE,KAAMuC,GACpBvC,KAAK+H,kBAAkBxF,IAGxByF,qBAAsB,GAMtBD,kBAAmB,SAA2BxF,GAC7C,IAAI0F,EAAWjI,KAAKiI,UAAYC,QAAO,kBACvC,GAAI3F,EAAO4F,cAAcF,EACxBjI,KAAKoI,OAAS7F,EAAO4F,OACf,CACN,IAAIE,EAA8B,iBAAd9F,EAAO4F,GAAkB5F,EAAO4F,GAAK,oBACzDnI,KAAKoI,OAAS,IAAIH,EAASI,GAC3BrI,KAAKoI,OAAOE,OAAM,sBAClBtI,KAAKoI,OAAOE,OAAM,wBAClBtI,KAAKoI,OAAOE,OAAM,sBAEnBtI,KAAKuI,cAAgBhG,EAAOiG,WAG7BC,gBAAiB,SAAyBD,EAAWE,GACpD,IAAIC,EAAgBlC,OAAOmC,KAAKF,EAAUtI,SAAS4B,IAAI,SAAUrB,GAC/D,MAAO,KAAMA,EAAE,UACbM,KAAI,MACP4H,EAAgBpC,OAAOmC,KAAKF,EAAUrI,SAAS2B,IAAI,SAAUrB,GAC5D,MAAO,OAAQA,EAAE,kBAAoBA,EAAE,kBAAoBA,EAAE,aAC3DM,KAAI,MACP6H,EAAiBJ,EAAUvI,SAAS6B,IAAI,SAAU+G,EAAGvH,GACpD,MAAO,IAAKA,EAAE,aACZP,KAAI,MACR,OAAOjB,KAAKgJ,WAAU,8BAAgCR,EACrD,kDACAG,EAAc,KAAOE,EAAc,KAAOC,EAAe,MAG3DE,WAAY,SAAoBC,GAC/B,IAAIC,EAAOtI,MAAMuI,UAAUC,MAAMhF,KAAKiF,UAAW,GACjD,IACC,IAAIC,EAAOtJ,KAAKoI,OAAOmB,QAAQN,GAC/B,OAAOK,EAAKrE,IAAIuE,MAAMF,EAAMJ,GAC3B,MAAOO,GACR,MAAM,IAAIC,MAAK,oBAAsBT,EAAI,KAAO/H,KAAKC,UAAU+H,GAAM,OAIvES,WAAY,SAAoBV,GAC/B,IAAIC,EAAOtI,MAAMuI,UAAUC,MAAMhF,KAAKiF,UAAW,GACjD,IACC,IAAIC,EAAOtJ,KAAKoI,OAAOmB,QAAQN,GAC/B,OAAOK,EAAKM,IAAIJ,MAAMF,EAAMJ,GAC3B,MAAOO,GACR,MAAM,IAAIC,MAAK,mBAAqBT,EAAI,KAAO/H,KAAKC,UAAU+H,GAAM,OAMtExG,KAAM,SAAc6B,EAAMsD,GACzB7H,KAAKuI,cAAgBvI,KAAKuI,eAAiB,MAAOhE,EAAKsF,KACvD,IAAInB,EAAYb,EAAOrD,cAAcD,EAAM,EAAGA,EAAKxC,SAAS,GAC5D/B,KAAKyI,gBAAgBzI,KAAKuI,cAAeG,IAG1C/F,QAAS,SAAiBmH,GAIzB,GAHKlJ,MAAMC,QAAQiJ,KAClBA,GAAUA,MAEPA,EAAOhJ,OAAS,GAApB,CAGA,IAAI2C,EAAKzD,KACRgI,EAAuBvE,EAAGuE,qBAE1B5G,EADQ0I,EAAO,GACA1I,SACf2I,EAAStD,OAAOmC,KAAKxH,GACrB4I,EAAeD,EAAO3E,OAAO,SAAU1D,GACtC,MAAO,sBAAsBuI,KAAKvI,KAEnCuH,EAAM,eAAgBjJ,KAAKuI,cAAc,KAAOwB,EAAO9I,KAAI,KAAM,YAChEjC,EAASkL,OAAM,IAAMlL,EAASkL,OAAM,IAAMH,EAAOjJ,QAAQG,KAAI,KAAM,IAClEoC,KAAKO,IAAIkG,EAAOhJ,OAAQkH,IAAuB/G,KAAI,KAAM,wGAGrD+I,EAAahI,IAAI,SAAUN,GAC9B,OAAOA,EAAE,MAAQA,EAAE,eAAiBA,IAClCT,KAAI,MACVhC,EAAS6K,GAAQK,OAAOnC,GAAsB1G,QAAQ,SAAU8H,GAC/D3F,EAAGuF,WAAWC,EAAKhK,EAASmK,GAAOpH,IAAI,SAAUhB,GAChD,IAAII,EAASJ,EAAMI,SACnB,OAAO2I,EAAO/H,IAAI,SAAUT,GAC3B,OAAOH,EAAOG,OAEbgE,UAAUtB,eAIfrB,MAAO,WACN,OAAO5C,KAAK2J,WAAU,iBAAmB3J,KAAKuI,eAC5CvG,IAAInC,EAAKuK,WAAWxC,KAAK/H,ON3G7BH,EAAM2K,WAGDhM,EAAiB,SAAkBkG,GAEtC,OAD4B,iBAATA,EAAoBA,EAAOA,EAAK+F,OACtCC,MAAK,IAAKvI,IAAI,SAAUwI,GACpC,MAAe,MAARA,EAAc,EAAe,MAARA,GAAgB,EAAK,KAI/ClM,EAAiBI,EAAQwF,GAC5BpE,YAAa,SAAwByC,GACpC2B,EAAgBE,KAAKpE,KAAMuC,IAG5BgC,KAAM,IAAInG,EAAQsB,MAAM2K,UAExBlK,SAAU9B,EAEVmG,cAAe,SAAuBD,EAAMrE,EAAK6B,GAChD,IAAIqE,EAAQrE,EAASA,EAAME,eAAc,MAASF,EAAM0I,GAAK1I,EAAM2I,GAAM,IAKzE,OAJS1K,KAAKyE,QAAQF,EAAMrE,EAAK6B,GAC/BzB,GAAIiE,EAAK+F,MAAQlE,EACjBjG,SAAUH,KAAKG,SAASoE,SAWxBhG,IACF,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,IAChB,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,IAChB,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,IAChB,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,IAChB,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,IAChB,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,IAChB,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,IAChB,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,IAGdC,EAAa,SAAoB+F,GACpC,IAAI+F,EAAwB,iBAAT/F,EAAoBA,EAAOA,EAAK+F,MAClDK,EAAOpM,EAASyD,IAAI,SAAU4I,GAC7B,OAAOA,EAAQ5I,IAAI,SAAUR,GAC5B,OAAO8I,EAAMO,OAAOrJ,KAClBP,KAAI,MAIT,OAFA0J,EAAO/J,MAAMkK,KAAK,IAAIC,IAAIJ,KACrBK,OACEL,GAGJlM,EAAsBC,EAAQwF,GACjCpE,YAAa,SAA6ByC,GACzC2B,EAAgBE,KAAKpE,KAAMuC,IAG5BgC,KAAM,IAAInG,EAAQsB,MAAM2K,UAExBlK,SAAU9B,EAEVE,SAAUA,EAIViG,cAAe,SAAkBD,EAAMrE,EAAK6B,GAC3C,IAAIgD,EAAY/E,KACfsK,EAAQ/F,EAAK+F,MAAMC,MAAK,IACxBU,EAAe1G,EAAK0G,eAQrB,OAPIlJ,IACHuI,EAAMvI,EAAMkJ,IAAiB,KAEjBzM,EAAW8L,EAAMrJ,KAAI,KAAMe,IAAI,SAAUkJ,GACrD,IAAI1E,EAAI0E,EAAEC,QAAO,KACjB,OAAOD,EAAEE,QAAO,IAAM,KAAO5E,IAEhBxE,IAAI,SAAWsI,GAI5B,OAHIvI,IACHA,EAAMkJ,IAAkBX,EAAM3I,OAAO,IAE/BoD,EAAUN,QAAQF,EAAMrE,EAAK6B,GACjC5B,SAAU4E,EAAU5E,SAASmK,EAAM3I,OAAO,EAAE,YAOjDtD,eAAgBA,EAChBC,eAAgBA,EAEhBC,SAAUA,EACVC,WAAYA,EACZC,oBAAqBA,IOlFvBkB,EAAS0L,SAAW,SAAkBC,EAAUxG,GAE/C,IAAIP,GADJO,EAAUA,OACSP,MAAQ+G,EAAS/G,KACnCgH,EAAInI,MAAM0B,EAAQyG,GAAK,KAAOzG,EAAQyG,EACtCC,EAAU1G,EAAQ0G,SAAWF,EAC7BG,EAAY3G,EAAQ2G,YAAcD,GAC9B5K,MAAMC,QAAQ4K,KAClBA,GAAaA,IAEd,IACCC,EADgB,IAAItN,EAAQuN,YAAYC,YAAYrH,EAAMiH,EAASC,EAAW,GACxDI,cAAc5H,UACrC,OAAOqH,EACL9F,WAAWxG,EAAS8M,MAAMzI,KAAK0I,KAAKR,EAAIG,EAAS5K,SACjDkL,QAAQN,GACRzI,SAAS,SAAUzB,EAAGqD,GACtB,OAAO,IAAIzG,EAAQ6N,MAAM1H,EAAMM,EAAM/C,WAClCgD,IC/BNlF,EAAMsM,OAAS,SAAgBZ,EAAUxG,GACxC,IAAI2G,EAAY3G,EAAQ2G,WACtB3G,EAAQqH,UAAYrH,EAAQqH,UAAY,IAAI/N,EAAQ0D,QAAQsK,aAC7D7H,EAAOO,EAAQP,MAAQ+G,EAAS/G,KAChC8H,EAAapN,EAASwM,GAAWzJ,IAAI,SAAU6F,GAC9C,OAAQA,EAAOgC,KAAM5K,EAASsF,EAAKzC,SAASE,IAAI,SAAUrB,GACxD,OAAQA,GAAI,EAAE,EAAE,MACduB,cACDA,WACJoK,EAAcxH,IAAYA,EAAQwH,aAAe,IACjDC,EAAuB,EACvB5G,EAAa,EACbC,EAASd,EAAQc,OAMlB,OALIA,IACHD,EAAaE,YAAY,WACxBD,EAAOE,KAAI,uBAAyByG,EAAqB,cACvDzH,EAAQiB,SAAW,MAEhB7H,EAAKgB,OAAO8G,SAAS9H,EAAKc,SAAS8M,MAAMQ,GAAaN,QAAQP,GAAY,SAAUe,GAC1F,IAAI3E,EAAS2E,EAAM,GAClBC,EAAevO,EAAKc,SAASkL,OAAOrC,EAAQtD,EAAKzC,QAAQhB,QAAQmD,UACjEyI,EAAcF,EAAM,GAAKjI,EAAKzC,QAAQhB,OACtC6L,EAAapI,EAAKzC,QAAQ4K,GAC3BD,EAAaC,GAAepB,EAC5B,IAAIzG,EAAQ,IAAIzG,EAAQ6N,MAAM1H,EAAMkI,GACpC,OAAO5H,EAAMI,MAAMC,KAAK,WACvB,IAAIxE,EAAImE,EAAMpE,SAASkM,GACvBN,EAAWxE,EAAOgC,MAAM8C,GAAYjM,EAAI,EAAI,EAAIA,EAAI,EAAI,EAAI,KAC5D6L,QAECrH,KAAK,WAKP,OAJAe,cAAcN,GACVC,GACHA,EAAOE,KAAI,uBAAyByG,EAAqB,aAEnDF,KAITzM,EAAMgN,kBAAoB,SAA2B/E,EAAQ/C,GAC5D,IAAI+E,EAAO/E,EAAQ+E,MAAQhC,EAAOgC,KACjCjE,EAASd,EAAQc,OACjBrB,EAAOO,EAAQP,MAAQsD,EAAOtD,KAI/B,OAHIqB,GACHA,EAAOE,KAAI,aAAevB,EAAKsF,KAAK,SAAWA,EAAK,KAE9ClK,EAAS0L,SAASxD,GACxB0D,EAAGzG,EAAQ+H,eAAiB,IAC5BrB,QAAS1G,EAAQ0G,SAAW,IAAIpN,EAAQ0D,QAAQsK,aAChDxG,OAAQA,IACNV,KAAK,WAEP,OADAU,EAAOE,KAAI,yBAA2BvB,EAAKsF,KAAK,iBAAmBA,EAAK,KACjE3L,EAAKgB,OAAO8G,SAASlB,EAAQ2G,YAAc,IAAIrN,EAAQ0D,QAAQsK,cAAiB,SAAUD,GAChG,OAAOvM,EAAMsM,OAAOrE,GAClBsE,SAAUA,EACVG,YAAaxH,EAAQwH,aAAe,GACpC1G,OAAQA,IACNV,KAAK,SAAUmH,GACjBzG,EAAOE,KAAI,WAAaqG,EAAStC,KAAK,KAAO3I,KAAKC,UAAUkL,WH7DzDlN","file":"ludorum-player-cbr.min.js","sourcesContent":["/** Package wrapper and layout.\n*/\nfunction __init__(base, Sermat, ludorum) { \"use strict\";\n// Import synonyms. ////////////////////////////////////////////////////////////////////////////////\n\tvar declare = base.declare,\n\t\tunimplemented = base.objects.unimplemented,\n\t\traise = base.raise,\n\t\traiseIf = base.raiseIf,\n\t\tRandomness = base.Randomness,\n\t\tIterable = base.Iterable,\n\t\titerable = base.iterable,\n\t\tFuture = base.Future;\n\n// Library layout. /////////////////////////////////////////////////////////////////////////////////\n\tvar exports = {\n\t\t\t__package__: 'ludorum-player-cbr',\n\t\t\t__name__: 'ludorum_player_cbr',\n\t\t\t__init__: __init__,\n\t\t\t__dependencies__: [base, Sermat, ludorum],\n\t\t\t__SERMAT__: { include: [base, ludorum] },\n\n\t\t\tdbs: { /* Namespace for different types of case bases. */ },\n\t\t\tgames: { /* Namespace for functions and definitions for supporting games. */ },\n\t\t\ttraining: { /* Namespace for functions and definitions related to populate or curate case bases. */ },\n\t\t\tutils: { /* Namespace for utility functions. */ }\n\t\t},\n\t\tdbs = exports.dbs,\n\t\tgames = exports.games,\n\t\ttraining = exports.training,\n\t\tutils = exports.utils\n\t;\n","/** # TicTacToe CBR\n \n*/\ngames.TicTacToe = (function () {\n\t/** ## Features direct from the board ###################################################### */\n\t\n\tvar directFeatures = function features(game) {\n\t\tvar board = typeof game === 'string' ? game : game.board;\n\t\treturn board.split('').map(function (chr) {\n\t\t\treturn chr === 'X' ? (+1) : chr === 'O' ? (-1) : 0; \n\t\t});\n\t};\n\n\tvar DirectCBPlayer = declare(CaseBasedPlayer, {\n\t\tconstructor: function DirectCBPlayer(params) {\n\t\t\tCaseBasedPlayer.call(this, params);\n\t\t}, \n\n\t\tgame: new ludorum.games.TicTacToe(),\n\n\t\tfeatures: directFeatures,\n\t\t\n\t\tcasesFromGame: function casesFromGame(game, ply, moves) {\n\t\t\tvar move  = moves ? (moves.hasOwnProperty('Xs') ? moves.Xs : moves.Os) : '?',\n\t\t\t\t_case = this.newCase(game, ply, moves, {\n\t\t\t\t\tid: game.board + move,\n\t\t\t\t\tfeatures: this.features(game) \n\t\t\t\t});\n\t\t\treturn [_case];\n\t\t}\n\t}); // declare TicTacToe.DirectCBPlayer\n\n\t/** ## Equivalence based on board symmetries and rotations. ################################ */\n\n\t/** `MAPPINGS` is a list of square indexes that define transformations between equivalent\n\tTictactoe boards.\n\t*/\n\tvar MAPPINGS = [\n\t\t[0,1,2,3,4,5,6,7,8], // original\n\t\t[2,1,0,5,4,3,8,7,6], // vertical axis symmetry\n\t\t[6,7,8,3,4,5,0,1,2], // horizontal axis symmetry\n\t\t[6,3,0,7,4,1,8,5,2], // 90 clockwise rotation\n\t\t[2,5,8,1,4,7,0,3,6], // 90 counter-clockwise rotation \n\t\t[8,7,6,5,4,3,2,1,0], // central symmetry\n\t\t[8,5,2,7,4,1,6,3,0], // 90 counter-clockwise rotation + vertical axis symmetry\n\t\t[0,3,6,1,4,7,2,5,8]  // 90 clockwise rotation + vertical axis symmetry\n\t];\n\n\tvar equivalent = function equivalent(game) {\n\t\tvar board = typeof game === 'string' ? game : game.board,\n\t\t\tmaps = MAPPINGS.map(function (mapping) {\n\t\t\t\treturn mapping.map(function (i) {\n\t\t\t\t\treturn board.charAt(i);\n\t\t\t\t}).join('');\n\t\t\t});\n\t\tmaps = Array.from(new Set(maps)); // Remove duplicates.\n\t\tmaps.sort();\n\t\treturn maps;\n\t};\n\n\tvar EquivalenceCBPlayer = declare(CaseBasedPlayer, {\n\t\tconstructor: function EquivalenceCBPlayer(params) {\n\t\t\tCaseBasedPlayer.call(this, params);\n\t\t}, \n\n\t\tgame: new ludorum.games.TicTacToe(),\n\n\t\tfeatures: directFeatures,\n\n\t\tMAPPINGS: MAPPINGS,\n\n\t\t/** \n\t\t*/\n\t\tcasesFromGame: function fromGame(game, ply, moves) {\n\t\t\tvar cbrPlayer = this,\n\t\t\t\tboard = game.board.split(''),\n\t\t\t\tactivePlayer = game.activePlayer();\n\t\t\tif (moves) {\n\t\t\t\tboard[moves[activePlayer]] = '!';\n\t\t\t}\n\t\t\tvar boards = equivalent(board.join('')).map(function (b) {\n\t\t\t\tvar m = b.indexOf('!');\n\t\t\t\treturn b.replace('!', '_') + m;\n\t\t\t});\n\t\t\treturn boards.map(function  (board) {\n\t\t\t\tif (moves) {\n\t\t\t\t\tmoves[activePlayer] = +(board.substr(9));\n\t\t\t\t}\n\t\t\t\treturn cbrPlayer.newCase(game, ply, moves, \n\t\t\t\t\t{ features: cbrPlayer.features(board.substr(0,9)) }\n\t\t\t\t);\n\t\t\t});\n\t\t}\n\t}); // declare TicTacToe.EquivalenceCBPlayer\n\n\treturn {\n\t\tdirectFeatures: directFeatures,\n\t\tDirectCBPlayer: DirectCBPlayer,\n\n\t\tMAPPINGS: MAPPINGS,\n\t\tequivalent: equivalent,\n\t\tEquivalenceCBPlayer: EquivalenceCBPlayer\n\t};\n})();","/** # Case\n\nTODO\n*/\nvar Case = exports.Case = declare({\n\t/** The `props` argument must have:\n\t\n\t+ `count`: the amount of times this case has been seen,\n\t+ `ply`: a number with the average ply where this case happens,\n\t+ `features`: an array of numbers representing the relevant information of the case,\n\t+ `actions`: an object mapping players to actions,\n\t+ `results`: an object mapping players to a 3 number array with the counts for: victories, \n\tdraws and defeats.\n\t*/\n\tconstructor: function Case(props) {\n\t\tthis.count = +props.count || 1;\n\t\tthis.ply = +props.ply;\n\t\tthis.features = props.features;\n\t\tthis.actions = props.actions;\n\t\tthis.results = props.results;\n\t\tthis.id = props.id || this.identifier();\n\t},\n\n\t/** Adding a result to a case updates the `results` property to acount for the given `result`. \n\t*/\n\taddResult: function addResult(result) {\n\t\tvar r;\n\t\tfor (var p in result) {\n\t\t\tr = result[p];\n\t\t\tif (Array.isArray(r) && r.length === 3) { // case results\n\t\t\t\tthis.results[p][0] += result[p][0];\n\t\t\t\tthis.results[p][1] += result[p][1];\n\t\t\t\tthis.results[p][2] += result[p][2];\n\t\t\t} else if (typeof r === 'number') {\n\t\t\t\tthis.results[p][r > 0 ? 0 : r === 0 ? 1 : 2]++;\n\t\t\t} else {\n\t\t\t\traise('Invalid result (', r, ')!');\n\t\t\t}\n\t\t}\n\t\tthis.count = (this.count || 0) + 1;\n\t\treturn this;\n\t},\n\n\t/** Merging `this` case with another case updates the properties `ply`, `count` and `results`.\n\t*/\n\tmerge: function merge(_case) {\n\t\tthis.ply = (this.ply * this.count + _case.ply * _case.count) / (this.count + _case.count);\n\t\tthis.count += _case.count;\n\t\tthis.addResult(_case.result);\n\t},\n\n\t// ## Databases ################################################################################\n\n\t/** An `identifier` for a case is a string that can be used as a primary key of a case base.\n\t*/\n\tidentifier: function identifier() {\n\t\treturn this.features.join('|') + JSON.stringify(this.actions);\n\t},\n\n\t/** Return a database record for this case.\n\t*/\n\trecord: function record(obj) {\n\t\tobj = obj || {};\n\t\tvar p;\n\t\tobj.id = this.id;\n\t\tobj.ply = this.ply;\n\t\tobj.count = this.count;\n\t\tthis.features.forEach(function (f, i) {\n\t\t\tobj['f'+ i] = f;\n\t\t});\n\t\tfor (p in this.actions) {\n\t\t\tobj['a_'+ p] = JSON.stringify(this.actions[p]);\n\t\t}\n\t\tfor (p in this.results) {\n\t\t\tobj['won_'+ p] = this.results[p][0];\n\t\t\tobj['tied_'+ p] = this.results[p][1];\n\t\t\tobj['lost_'+ p] = this.results[p][2];\n\t\t}\n\t\treturn obj;\n\t},\n\n\t/** The static method `fromRecord` creates a case from a database record.\n\t*/\n\t'static fromRecord': function fromRecord(record) {\n\t\tvar features = [],\n\t\t\tactions = {},\n\t\t\tresults = {};\n\t\tfor (var k in record) {\n\t\t\tif (k[0] === 'f') {\n\t\t\t\tfeatures[+k.substr(1)] = record[k];\n\t\t\t} else if (k.substr(0, 2) === 'a_') {\n\t\t\t\tactions[k.substr(2)] = JSON.parse(record[k]);\n\t\t\t} else if (k.substr(0, 4) === 'won_') {\n\t\t\t\tvar p = k.substr(4);\n\t\t\t\tresults[p] = [record['won_'+ p], record['tied_'+ p], record['lost_'+ p]];\n\t\t\t}\n\t\t}\n\t\treturn new this({ \n\t\t\tcount: record.count,\n\t\t\tply: record.ply,\n\t\t\tfeatures: features,\n\t\t\tactions: actions,\n\t\t\tresults: results\n\t\t});\n\t},\n\n\t// ## Utilities ################################################################################\n\n\t/** This method adds null actions to a copy of the `moves` object.\n\t*/\n\t'static actionsFromMoves': function getActions(players, moves) {\n\t\treturn iterable(players).map(function (p) {\n\t\t\treturn [p, moves && moves.hasOwnProperty(p) ? moves[p] : null];\n\t\t}).toObject();\n\t},\n\n\t/** `emptyResults` creates an object that maps every player to an array with 3 zeros.\n\t*/\n\t'static emptyResults': function emptyResults(players) {\n\t\treturn iterable(players).map(function (p) {\n\t\t\treturn [p, [0, 0, 0]];\n\t\t}).toObject();\n\t},\n\n\t/** Serialization and materialization using Sermat.\n\t*/\n\t'static __SERMAT__': {\n\t\tidentifier: 'Case',\n\t\tserializer: function serialize_Case(obj) {\n\t\t\treturn [{\n\t\t\t\tid: obj.id,\n\t\t\t\tcount: obj.count,\n\t\t\t\tply: obj.ply,\n\t\t\t\tfeatures: obj.features,\n\t\t\t\tactions: obj.actions,\n\t\t\t\tresults: obj.results\n\t\t\t}];\n\t\t}\n\t}\n}); // declare Case","/** # CaseBase \n\nA `CaseBase` holds all cases for a game.\n*/\nvar CaseBase = exports.CaseBase = declare({\n\tconstructor: function CaseBase(params) {\n\t\tthis.random = params && params.random || Randomness.DEFAULT;\n\t},\n\n\t/** ## Abstract methods ##################################################################### */\n\n\t/** Depending on its implementation, a case base may require information about the game and the\n\tplayer that uses it in order to work. \n\t*/\n\tinit: unimplemented('CaseBase', 'init(game, player)'),\n\n\t/** Adding a case (or cases) to the database is not implemented by default.\n\t*/\n\taddCase: unimplemented('CaseBase', 'addCase(_case)'),\n\n\t/** The `cases` method returns the sequence of all cases in the database. Case order is not\n\tdefined.\n\t*/\n\tcases: unimplemented('CaseBase', 'cases(filters)'),\n\n\t/** ## Case retrieval ####################################################################### */\n\n\t/** The default `distance` is a form of Manhattan distance, which does not count `null` or `NaN`\n\tfeatures.\n\t*/\n\tdistance: function distance(features1, features2) {\n\t\treturn base.Iterable.zip(features1, features2).mapApply(function (f1, f2) {\n\t\t\tif (f1 !== null && !isNaN(f1) && f2 !== null && !isNaN(f2)) {\n\t\t\t\treturn Math.abs(f1 - f2);\n\t\t\t} else {\n\t\t\t\treturn 0;\n\t\t\t}\n\t\t}).sum();\n\t},\n\n\t/** The `nn` method returns the `k` neareast neighbours of the given cases. \n\t*/\n\tnn: function nn(k, cases) {\n\t\tvar cb = this;\n\t\tcases = iterable(cases);\n\t\treturn iterable(this.cases()).map(function (_case) {\n\t\t\t\tvar d = cases.map(function (c) {\n\t\t\t\t\treturn cb.distance(_case.features, c.features);\n\t\t\t\t}).min();\n\t\t\t\treturn [_case, d];\n\t\t\t}).sorted(function (c1, c2) {\n\t\t\t\treturn c1[1] - c2[1];\n\t\t\t}).take(+k).toArray();\n\t}\n}); // declare CaseBase","/** # CaseBasedPlayer \n\n*/\nvar CaseBasedPlayer = exports.CaseBasedPlayer = base.declare(ludorum.Player, {\n\t/** \n\t*/\n\tconstructor: function CaseBasedPlayer(params) {\n\t\tludorum.Player.call(this, params);\n\t\tthis.k = params && params.k || 20;\n\t\tthis.caseBase = params && params.caseBase || new MemoryCaseBase();\n\t\tthis.caseBase.init(this.game, this);\n\t},\n\n\t/** The method `casesFromGame` takes a `game` state and returns a case. This object includes\n\tthe game state's features, ply, actions and results.\n\t*/\n\tcasesFromGame: base.objects.unimplemented('CaseBasedPlayer', 'casesFromGame(game, ply, moves)'),\n\n\t/** `newCase` is a helper for building a case.\n\t*/\n\tnewCase: function newCase(game, ply, moves, _case) {\n\t\t_case = _case || {};\n\t\tif (!_case.hasOwnProperty('ply')) {\n\t\t\t_case.ply = +ply;\n\t\t}\n\t\tif (!_case.hasOwnProperty('actions')) {\n\t\t\t_case.actions = Case.actionsFromMoves(game.players, moves);\n\t\t}\n\t\tif (!_case.hasOwnProperty('results')) {\n\t\t\t_case.results = Case.emptyResults(game.players);\n\t\t}\n\t\treturn new Case(_case);\n\t},\n\n\t/** ## Database building ################################################################### */\n\n\t/** The `addMatch` method runs the given `match` and adds all its game states as cases in the\n\tplayer's database. It returns a promise.\n\t*/\n\taddMatch: function addMatch(match, options) {\n\t\tvar cbrPlayer = this,\n\t\t\tretainThreshold = +options.retainThreshold || 0;\n\t\treturn match.run().then(function () {\n\t\t\tvar result = match.result(),\n\t\t\t\tcases = iterable(match.history).filter(function (entry) {\n\t\t\t\t\treturn !!entry.moves;\n\t\t\t\t}).map(function (entry, i) {\n\t\t\t\t\treturn cbrPlayer.casesFromGame(entry.state, i, entry.moves);  \n\t\t\t\t}).flatten().map(function (_case) {\n\t\t\t\t\treturn _case.addResult(result);\n\t\t\t\t});\n\t\t\tcbrPlayer.caseBase.addCase(cases.toArray());\n\t\t\treturn match;\n\t\t});\n\t},\n\n\t/** The `addMatches` method takes a sequence of `matches`, runs each in order and adds all \n\tresulting game states to the database. It returns a promise.\n\t*/\n\taddMatches: function addMatches(matches, options) {\n\t\tvar cbrPlayer = this,\n\t\t\tmatchCount = 0,\n\t\t\tintervalId = 0;\n\t\tif (options.logger) {\n\t\t\tintervalId = setInterval(function () {\n\t\t\t\toptions.logger.info(\"Added \"+ matchCount +\" matches.\");\n\t\t\t}, options.logTime || 30000);\n\t\t}\n\t\treturn Future.sequence(matches, function (match) {\n\t\t\tmatchCount++;\n\t\t\treturn cbrPlayer.addMatch(match, options);\n\t\t}).then(function (r) {\n\t\t\tif (options.logger) {\n\t\t\t\toptions.logger.info(\"Added \"+ matchCount +\" matches.\");\n\t\t\t}\n\t\t\tclearInterval(intervalId);\n\t\t\treturn r;\n\t\t});\n\t},\n\n\t/** ## Playing ############################################################################# */\n\n\t/** `actionEvaluations` assigns a number to every action available to the given `role` at the\n\tgiven `game` state. It uses the case base to retrieve the _k_ most similar cases. \n\t*/\n\tactionEvaluations: function actionEvaluations(game, role, options) { //FIXME\n\t\tvar k = options && +options.k || this.k,\n\t\t\tr = base.iterable(game.moves()[role]).map(function (move) {\n\t\t\t\treturn [JSON.stringify(move), [move, 0]];\n\t\t\t}).toObject(),\n\t\t\tknn = this.caseBase.nn(k, this.casesFromGame(game));\n\t\titerable(knn).forEachApply(function (_case, distance) {\n\t\t\tvar m = r[JSON.stringify(_case.actions[role])],\n\t\t\t\tresult = _case.results[role],\n\t\t\t\tev, support, ratio;\n\t\t\tif (m) {\n\t\t\t\tsupport = _case.count / (10 + _case.count);\n\t\t\t\tratio = (result[0] + result[2] && \n\t\t\t\t\t((result[0] - result[2]) / (result[0] + result[2])));\n\t\t\t\tev = support * ratio * (1 / (1 + distance));\n\t\t\t\tif (isNaN(ev)) {\n\t\t\t\t\traise(\"Action evaluation is NaN for case: \", JSON.stringify(_case),\n\t\t\t\t\t\t\" (distance= \", distance, \")!\");\n\t\t\t\t}\n\t\t\t\tm[1] += ev;\n\t\t\t}\n\t\t});\n\t\treturn Object.values(r);\n\t},\n\n\t/** `gameEvaluation` assigns a number to the given `game` state. It uses the case base to\n\tretrieve the _k_ most similar cases, and aggregates their results. It is suitable for an \n\theuristic player. \n\t*/\n\tgameEvaluation: function gameEvaluation(game, role, options) { //FIXME\n\t\tvar k = options && +options.k || this.k,\n\t\t\tr = base.iterable(game.moves()[role]).map(function (move) {\n\t\t\t\treturn [JSON.stringify(move), [move, 0]];\n\t\t\t}).toObject(),\n\t\t\tknn = cb.nn(k, game, role);\n\t\treturn iterable(knn).map(function (_case, distance) {\n\t\t\treturn (_case.results[role][0] - _case.results[role][2]) / (1 + distance);\n\t\t}).sum();\n\t},\n\n\t/** `checkMoves` classifies all moves available to the given `role` at the given `game` state.\n\tThe result is an array of two arrays of moves. The first array has all the winning moves, while\n\tthe second array has all the moves that do not finish the game. Losing and drawing moves are\n\tdiscarded.  \n\t*/\n\tcheckMoves: function checkMoves(game, role) {\n\t\tvar r = [[], []];\n\t\tthis.movesFor(game, role).forEach(function (move) {\n\t\t\tvar game2 = game.perform(move, role),\n\t\t\t\tresult = game2.result();\n\t\t\tif (!result) {\n\t\t\t\tr[1].push(move); // Not a losing move.\n\t\t\t} else if (result[role] > 0) {\n\t\t\t\tr[0].push(move); // Winning move.\n\t\t\t}\n\t\t});\n\t\treturn r;\n\t},\n\n\t/** A `CaseBasedPlayer` takes the action evaluations from the case base, and splits them into\n\tactions with possitive evaluations and the ones with evaluations less than or equal to zero. If \n\tthere are possitively evaluated actions, one of these is chosen randomly with a probability \n\tproportional to the evaluation. If all actions have non possitive evaluations, one of these is\n\tchosen with a probability inversely proportional to the evaluation.   \n\t*/\n\tdecision: function decision(game, role) {\n\t\tvar checkMoves = this.checkMoves(game, role);\n\t\tif (checkMoves[0].length > 0) {\n\t\t\treturn this.random.choice(checkMoves[0]);\n\t\t} else if (checkMoves[1].length < 2) {\n\t\t\tif (checkMoves[1].length === 1) {\n\t\t\t\treturn checkMoves[1][0];\n\t\t\t} else { // if (checkMoves[1].length < 1)\n\t\t\t\treturn this.random.choice(this.movesFor(game, role));\n\t\t\t}\n\t\t}\n\t\tvar actions = iterable(checkMoves[1]).map(function (action) {\n\t\t\t\treturn [action +'', [action, 0]];\n\t\t\t}).toObject();\n\t\tthis.actionEvaluations(game, role, { k: this.k }).forEach(function (t) {\n\t\t\tvar entry = actions[t[0] +''];\n\t\t\tif (entry) {\n\t\t\t\tentry[1] += t[1];\n\t\t\t}\n\t\t});\n\t\tvar minEval = +Infinity,\n\t\t\tpositiveActions = Object.values(actions).filter(function (t) {\n\t\t\t\tminEval = Math.min(minEval, t[1]);\n\t\t\t\treturn t[1] > 0;\n\t\t\t}),\n\t\t\tnegativeActions = Object.values(actions).filter(function (t) {\n\t\t\t\treturn t[1] <= 0;\n\t\t\t}).map(function (t) {\n\t\t\t\treturn [t[0], t[1] - minEval];\n\t\t\t}),\n\t\t\tresult;\n\t\tif (positiveActions.length > 1) {\n\t\t\tresult = this.random.weightedChoice(this.random.normalizeWeights(positiveActions));\n\t\t} else if (positiveActions.length === 1) {\n\t\t\tresult = positiveActions[0][0];\n\t\t} else {\n\t\t\tresult = this.random.weightedChoice(this.random.normalizeWeights(negativeActions));\n\t\t}\n\t\treturn result;\n\t}\n}); // declare CBRPlayer","/** # MemoryCaseBase\n\nA memory implementation of a `CaseBase`.\n*/\nvar MemoryCaseBase = dbs.MemoryCaseBase = declare(CaseBase, {\n\tconstructor: function MemoryCaseBase(params) {\n\t\tCaseBase.call(this, params);\n\t\tthis.__cases__ = [];\n\t\tthis.__index__ = {};\n\t\tif (params && params.__cases__) {\n\t\t\tparams.__cases__.forEach(this.addCase.bind(this));\n\t\t}\n\t},\n\n\tinit: function init(game, player) {\n\t\t// No initialization required.\n\t},\n\n\tcases: function cases() {\n\t\treturn base.iterable(this.__cases__);\n\t},\n\t\n\taddCase: function addCase(_case) {\n\t\tif (_case instanceof Case) {\n\t\t\tvar id = _case.identifier();\n\t\t\tif (this.__index__.hasOwnProperty(id)) {\n\t\t\t\tvar storedCase = this.__cases__[this.__index__[id]];\n\t\t\t\tstoredCase.merge(_case);\n\t\t\t} else {\n\t\t\t\tvar i = this.__cases__.push(_case) - 1;\n\t\t\t\tthis.__index__[id] = i;\n\t\t\t}\n\t\t} else {\n\t\t\titerable(_case).forEach(this.addCase.bind(this));\n\t\t}\n\t},\n\n\t/** ## Utilities ############################################################################ */\n\n\t'static __SERMAT__': {\n\t\tidentifier: 'MemoryCaseBase',\n\t\tserializer: function serialize_MemoryCaseBase(obj) {\n\t\t\treturn [{\n\t\t\t\t__cases__: obj.__cases__\n\t\t\t}];\n\t\t}\n\t},\n}); // declare MemoryCaseBase","// See __prologue__.js\n\treturn exports;\n}\n","/** # SQLiteCaseBase\n\nAn implementation of a `CaseBase` using SQLite3 through `better-sqlite3`.\n*/\ndbs.SQLiteCaseBase = declare(CaseBase, {\n\t/** \n\t*/\n\tconstructor: function SQLiteCaseBase(params) {\n\t\tCaseBase.call(this, params);\n\t\tthis.__setupDatabase__(params);\n\t},\n\n\tMAX_CASES_PER_UPSERT: 10,\n\t\t\n\t/** ## Database setup and management ######################################################## */\n\n\t/**\n\t*/\n\t__setupDatabase__: function __setupDatabase__(params) {\n\t\tvar Database = this.Database || require('better-sqlite3');\n\t\tif (params.db instanceof Database) {\n\t\t\tthis.__db__ = params.db;\n\t\t} else {\n\t\t\tvar dbName = typeof params.db === 'string' ? params.db : './cbr-test.sqlite';\n\t\t\tthis.__db__ = new Database(dbName);\n\t\t\tthis.__db__.pragma('journal_mode = OFF'); // Disable transactions.\n\t\t\tthis.__db__.pragma('cache_size = -128000'); // Increase default cache size.\n\t\t\tthis.__db__.pragma('encoding = \"UTF-8\"'); // Increase default cache size.\n\t\t}\n\t\tthis.__tableName__ = params.tableName;\n\t},\n\n\t__createTable__: function __createTable__(tableName, reference) {\n\t\tvar actionColumns = Object.keys(reference.actions).map(function (p) {\n\t\t\t\treturn 'a_'+ p +' TEXT';\n\t\t\t}).join(', '),\n\t\t\tresultColumns = Object.keys(reference.results).map(function (p) {\n\t\t\t\treturn 'won_'+ p +' INTEGER, tied_'+ p +' INTEGER, lost_'+ p +' INTEGER';\n\t\t\t}).join(', '),\n\t\t\tfeatureColumns = reference.features.map(function (_, i) {\n\t\t\t\treturn 'f'+ i +' INTEGER';\n\t\t\t}).join(', ');\n\t\treturn this.__runSQL__('CREATE TABLE IF NOT EXISTS '+ tableName +\n\t\t\t'(id TEXT PRIMARY KEY, count INTEGER, ply REAL, '+\n\t\t\tactionColumns +', '+ resultColumns +', '+ featureColumns +')');\n\t},\n\n\t__runSQL__: function __runSQL__(sql) {\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\t\ttry {\n\t\t\tvar stmt = this.__db__.prepare(sql);\n\t\t\treturn stmt.run.apply(stmt, args);\n\t\t} catch (err) {\n\t\t\tthrow new Error(\"Error executing `\"+ sql +\"` \"+ JSON.stringify(args) +\"!\");\n\t\t}\n\t},\n\n\t__getSQL__: function __getSQL__(sql) {\n\t\tvar args = Array.prototype.slice.call(arguments, 1);\n\t\ttry {\n\t\t\tvar stmt = this.__db__.prepare(sql);\n\t\t\treturn stmt.all.apply(stmt, args);\n\t\t} catch (err) {\n\t\t\tthrow new Error(\"Error querying `\"+ sql +\"` \"+ JSON.stringify(args) +\"!\");\n\t\t}\n\t},\n\n\t/** ## Cases ############################################################################### */\n\n\tinit: function init(game, player) {\n\t\tthis.__tableName__ = this.__tableName__ || 'CB_'+ game.name;\n\t\tvar reference = player.casesFromGame(game, 0, game.moves())[0];\n\t\tthis.__createTable__(this.__tableName__, reference);\n\t},\n\t\n\taddCase: function addCase(_cases) {\n\t\tif (!Array.isArray(_cases)) {\n\t\t\t_cases = [_cases]; \n\t\t}\n\t\tif (_cases.length < 1) {\n\t\t\treturn;\n\t\t}\n\t\tvar cb = this,\n\t\t\tMAX_CASES_PER_UPSERT = cb.MAX_CASES_PER_UPSERT,\n\t\t\t_case = _cases[0],\n\t\t\trecord = _case.record(),\n\t\t\tfields = Object.keys(record),\n\t\t\tresultFields = fields.filter(function (k) {\n\t\t\t\treturn /^(won_|tied_|lost_)/.test(k);\n\t\t\t}),\n\t\t\tsql = 'INSERT INTO '+ this.__tableName__ +' ('+ fields.join(',') +') VALUES '+\n\t\t\t\tIterable.repeat('('+ Iterable.repeat('?', fields.length).join(',') +')',\n\t\t\t\t\tMath.min(_cases.length, MAX_CASES_PER_UPSERT)).join(',') +' '+\n\t\t\t\t'ON CONFLICT(id) DO UPDATE SET'+\n\t\t\t\t' count = count + 1, ply = (ply * count + excluded.ply) / (count + 1), '+\n\t\t\t\t' '+ resultFields.map(function (k) {\n\t\t\t\t\t\treturn k +' = '+ k +' + excluded.'+ k;\n\t\t\t\t\t}).join(', '); \n\t\titerable(_cases).slices(MAX_CASES_PER_UPSERT).forEach(function (slice) {\n\t\t\tcb.__runSQL__(sql, iterable(slice).map(function (_case) {\n\t\t\t\tvar record = _case.record();\n\t\t\t\treturn fields.map(function (f) {\n\t\t\t\t\treturn record[f];\n\t\t\t\t});\n\t\t\t}).flatten().toArray());\n\t\t});\n\t},\n\n\tcases: function cases() {\n\t\treturn this.__getSQL__('SELECT * FROM '+ this.__tableName__)\n\t\t\t.map(Case.fromRecord.bind(Case));\n\t},\n\n\t/*FIXME\n\t__nn_sql__: function __nn_sql__(k, game) {\n\t\tvar cases = this.Case.fromGame(game);\n\t\treturn 'SELECT *, min('+ cases.map(function (_case) {\n\t\t\t\treturn _case.features.map(function (v, i) {\n\t\t\t\t\treturn v !== null && !isNaN(v) ? 'abs(ifnull(f'+ i +'-('+ v +'),0))' : '0';\n\t\t\t\t}).join('+');\n\t\t\t}).join(', ') +') AS distance '+\n\t\t\t'FROM '+ this.__tableName__ +' '+\n\t\t\t'ORDER BY distance ASC LIMIT '+ k;\n\t},\n\n\tnn: function nn(k, game) {\n\t\tvar cb = this,\n\t\t\tsql = this.__nn_sql__(k, game);\n\t\treturn this.__db__.prepare(sql).all().map(function (row) {\n\t\t\treturn [cb.Case.fromRecord(row), row.distance];\n\t\t});\n\t}\n\t*/\n}); // declare SQLiteCaseBase\n\n","/** # Training\n\nFunctions and definitions related to populate or curate case bases.\n*/\n\n/** The `populate` function adds cases to the database by running several matches and adding the\nresulting game states. The `options` argument may include the following:\n\n+ `game`: The game state from which to start the matches. The database's `game` is used by \ndefault.\n\n+ `n`: The number of matches to run; 100 by default.\n\n+ `trainer`: The player to use agains the opponents. This player is used by default.\n\n+ `opponents`: The trainer's opponents to use to play the matches. The trainer is used by default.\n\nOther options are passed to the `addMatches` method. The result is a promise.\n*/\ntraining.populate = function populate(cbPlayer, options) {\n\toptions = options || {};\n\tvar game = options.game || cbPlayer.game,\n\t\tn = isNaN(options.n) ? 100 : +options.n,\n\t\ttrainer = options.trainer || cbPlayer,\n\t\topponents = options.opponents || [trainer];\n\tif (!Array.isArray(opponents)) {\n\t\topponents = [opponents];\n\t}\n\tvar tournament = new ludorum.tournaments.Measurement(game, trainer, opponents, 1),\n\t\tmatchups = tournament.__matches__().toArray();\n\treturn cbPlayer\n\t\t.addMatches(Iterable.range(Math.ceil(n / matchups.length))\n\t\t.product(matchups)\n\t\t.mapApply(function (i, match) {\n\t\t\treturn new ludorum.Match(game, match.players);\n\t\t}), options);\n};","/** # Utilities\n\n*/\n\nutils.assess = function assess(cbPlayer, options) {\n\tvar opponents = options.opponents || \n\t\t\toptions.opponent ? [options.opponent] : new ludorum.players.RandomPlayer(),\n\t\tgame = options.game || cbPlayer.game,\n\t\tevaluation = iterable(opponents).map(function (player) {\n\t\t\treturn [player.name, iterable(game.players).map(function (p) {\n\t\t\t\t\treturn [p, [0,0,0]];\n\t\t\t\t}).toObject()];\n\t\t\t}).toObject(),\n\t\tassessCount = options && +options.assessCount || 300,\n\t\tfinishedMatchesCount = 0,\n\t\tintervalId = 0,\n\t\tlogger = options.logger;\n\tif (logger) {\n\t\tintervalId = setInterval(function () {\n\t\t\tlogger.info(\"Assessment finished \"+ finishedMatchesCount +\" matches.\");\n\t\t}, options.logTime || 30000);\n\t}\n\treturn base.Future.sequence(base.Iterable.range(assessCount).product(opponents), function (tuple) {\n\t\tvar player = tuple[1],\n\t\t\tmatchPlayers = base.Iterable.repeat(player, game.players.length).toArray(),\n\t\t\tplayerIndex = tuple[0] % game.players.length,\n\t\t\tplayerRole = game.players[playerIndex];\n\t\tmatchPlayers[playerIndex] = cbPlayer;\n\t\tvar match = new ludorum.Match(game, matchPlayers);\n\t\treturn match.run().then(function () {\n\t\t\tvar r = match.result()[playerRole];\n\t\t\tevaluation[player.name][playerRole][r > 0 ? 0 : r < 0 ? 2 : 1]++;\n\t\t\tfinishedMatchesCount++;\n\t\t});\n\t}).then(function () {\n\t\tclearInterval(intervalId);\n\t\tif (logger) {\n\t\t\tlogger.info(\"Assessment finished \"+ finishedMatchesCount +\" matches.\");\n\t\t}\n\t\treturn evaluation;\n\t});\n};\n\nutils.populateAndAssess = function populateAndAssess(player, options) {\n\tvar name = options.name || player.name,\n\t\tlogger = options.logger,\n\t\tgame = options.game || player.game;\n\tif (logger) {\n\t\tlogger.info(\"Assessing \"+ game.name +\" with \"+ name +\".\");\n\t}\n\treturn training.populate(player, { \n\t\tn: options.populateCount || 1000,\n\t\ttrainer: options.trainer || new ludorum.players.RandomPlayer(),\n\t\tlogger: logger \n\t}).then(function () {\n\t\tlogger.info(\"Evaluating player for \"+ game.name +\" trained with \"+ name +\".\");\n\t\treturn base.Future.sequence(options.opponents || [new ludorum.players.RandomPlayer()], function (opponent) {\n\t\t\treturn utils.assess(player, {\n\t\t\t\t\topponent: opponent,\n\t\t\t\t\tassessCount: options.assessCount || 80, \n\t\t\t\t\tlogger: logger \n\t\t\t\t}).then(function (evaluation) {\n\t\t\t\t\tlogger.info(\"Against \"+ opponent.name +\": \"+ JSON.stringify(evaluation));\n\t\t\t\t});\n\t\t});\n\t});\n};\n"]}