//! ludorum-player-cbr 0.0.1

(function(e){"use strict";"function"==typeof define&&define.amd?define(["creatartis-base","sermat","ludorum"],e):"object"==typeof exports&&module.exports?module.exports=e(require("creatartis-base"),require("sermat"),require("ludorum")):this["ludorum-player-cbr"]=e(this.base,this.Sermat,this.ludorum)}).call(this,function e(t,n,r){"use strict";var s,a,i,o,u,c=t.declare,l=t.objects.unimplemented,_=t.raise,f=(t.raiseIf,t.Randomness),h=t.Iterable,m=t.iterable,p=t.Future,d={__package__:"ludorum-player-cbr",__name__:"ludorum_player_cbr",__init__:e,__dependencies__:[t,n,r],__SERMAT__:{include:[t,r]},dbs:{},games:{},training:{},utils:{}},y=d.dbs,g=d.games,b=d.training,v=d.utils,E=d.Case=c({constructor:function(e){this.count=+e.count||1,this.ply=+e.ply,this.features=e.features,this.actions=e.actions,this.results=e.results,this.id=e.id||this.identifier()},addResult:function(e){var t;for(var n in e)t=e[n],Array.isArray(t)&&3===t.length?(this.results[n][0]+=e[n][0],this.results[n][1]+=e[n][1],this.results[n][2]+=e[n][2]):"number"==typeof t?this.results[n][t>0?0:0===t?1:2]++:_("Invalid result (",t,")!");return this.count=(this.count||0)+1,this},merge:function(e){this.ply=(this.ply*this.count+e.ply*e.count)/(this.count+e.count),this.count+=e.count,this.addResult(e.result)},identifier:function(){return this.features.join("|")+JSON.stringify(this.actions)},record:function(e){var t;for(t in(e=e||{}).id=this.id,e.ply=this.ply,e.count=this.count,this.features.forEach(function(t,n){e["f"+n]=t}),this.actions)e["a_"+t]=JSON.stringify(this.actions[t]);for(t in this.results)e["won_"+t]=this.results[t][0],e["tied_"+t]=this.results[t][1],e["lost_"+t]=this.results[t][2];return e},"static fromRecord":function(e){var t=[],n={},r={};for(var s in e)if("f"===s[0])t[+s.substr(1)]=e[s];else if("a_"===s.substr(0,2))n[s.substr(2)]=JSON.parse(e[s]);else if("won_"===s.substr(0,4)){var a=s.substr(4);r[a]=[e["won_"+a],e["tied_"+a],e["lost_"+a]]}return new this({count:e.count,ply:e.ply,features:t,actions:n,results:r})},"static actionsFromMoves":function(e,t){return m(e).map(function(e){return[e,t&&t.hasOwnProperty(e)?t[e]:null]}).toObject()},"static emptyResults":function(e){return m(e).map(function(e){return[e,[0,0,0]]}).toObject()},"static __SERMAT__":{identifier:"Case",serializer:function(e){return[{id:e.id,count:e.count,ply:e.ply,features:e.features,actions:e.actions,results:e.results}]}}}),A=d.CaseBase=c({constructor:function(e){this.random=e&&e.random||f.DEFAULT},init:l("CaseBase","init(game, player)"),addCase:l("CaseBase","addCase(_case)"),cases:l("CaseBase","cases(filters)"),distance:function(e,n){return t.Iterable.zip(e,n).mapApply(function(e,t){return null===e||isNaN(e)||null===t||isNaN(t)?0:Math.abs(e-t)}).sum()},nn:function(e,t){var n=this;return t=m(t),m(this.cases()).map(function(e){var r=t.map(function(t){return n.distance(e.features,t.features)}).min();return[e,r]}).sorted(function(e,t){return e[1]-t[1]}).take(+e).toArray()}}),N=d.CaseBasedPlayer=t.declare(r.Player,{constructor:function(e){r.Player.call(this,e),this.k=e&&e.k||20,this.caseBase=e&&e.caseBase||new O,this.caseBase.init(this.game,this)},casesFromGame:t.objects.unimplemented("CaseBasedPlayer","casesFromGame(game, ply, moves)"),newCase:function(e,t,n,r){return(r=r||{}).hasOwnProperty("ply")||(r.ply=+t),r.hasOwnProperty("actions")||(r.actions=E.actionsFromMoves(e.players,n)),r.hasOwnProperty("results")||(r.results=E.emptyResults(e.players)),new E(r)},addMatch:function(e,t){var n=this;t.retainThreshold;return e.run().then(function(){var t=e.result(),r=m(e.history).filter(function(e){return!!e.moves}).map(function(e,t){return n.casesFromGame(e.state,t,e.moves)}).flatten().map(function(e){return e.addResult(t)});return n.caseBase.addCase(r.toArray()),e})},addMatches:function(e,t){var n=this,r=0,s=0;return t.logger&&(s=setInterval(function(){t.logger.info("Added "+r+" matches.")},t.logTime||3e4)),p.sequence(e,function(e){return r++,n.addMatch(e,t)}).then(function(e){return t.logger&&t.logger.info("Added "+r+" matches."),clearInterval(s),e})},actionEvaluations:function(e,n,r){var s=r&&+r.k||this.k,a=t.iterable(e.moves()[n]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),i=this.caseBase.nn(s,this.casesFromGame(e));return m(i).forEachApply(function(e,t){var r,s=a[JSON.stringify(e.actions[n])],i=e.results[n];s&&(r=e.count/(10+e.count)*(i[0]+i[2]&&(i[0]-i[2])/(i[0]+i[2]))*(1/(1+t)),isNaN(r)&&_("Action evaluation is NaN for case: ",JSON.stringify(e)," (distance= ",t,")!"),s[1]+=r)}),Object.values(a)},gameEvaluation:function(e,n,r){var s=r&&+r.k||this.k,a=(t.iterable(e.moves()[n]).map(function(e){return[JSON.stringify(e),[e,0]]}).toObject(),cb.nn(s,e,n));return m(a).map(function(e,t){return(e.results[n][0]-e.results[n][2])/(1+t)}).sum()},checkMoves:function(e,t){var n=[[],[]];return this.movesFor(e,t).forEach(function(r){var s=e.perform(r,t).result();s?s[t]>0&&n[0].push(r):n[1].push(r)}),n},decision:function(e,t){var n=this.checkMoves(e,t);if(n[0].length>0)return this.random.choice(n[0]);if(n[1].length<2)return 1===n[1].length?n[1][0]:this.random.choice(this.movesFor(e,t));var r=m(n[1]).map(function(e){return[e+"",[e,0]]}).toObject();this.actionEvaluations(e,t,{k:this.k}).forEach(function(e){var t=r[e[0]+""];t&&(t[1]+=e[1])});var s=1/0,a=Object.values(r).filter(function(e){return s=Math.min(s,e[1]),e[1]>0}),i=Object.values(r).filter(function(e){return e[1]<=0}).map(function(e){return[e[0],e[1]-s]});return a.length>1?this.random.weightedChoice(this.random.normalizeWeights(a)):1===a.length?a[0][0]:this.random.weightedChoice(this.random.normalizeWeights(i))}}),O=y.MemoryCaseBase=c(A,{constructor:function(e){A.call(this,e),this.__cases__=[],this.__index__={},e&&e.__cases__&&e.__cases__.forEach(this.addCase.bind(this))},init:function(e,t){},cases:function(){return t.iterable(this.__cases__)},addCase:function(e){if(e instanceof E){var t=e.identifier();if(this.__index__.hasOwnProperty(t)){this.__cases__[this.__index__[t]].merge(e)}else{var n=this.__cases__.push(e)-1;this.__index__[t]=n}}else m(e).forEach(this.addCase.bind(this))},"static __SERMAT__":{identifier:"MemoryCaseBase",serializer:function(e){return[{__cases__:e.__cases__}]}}});return y.SQLiteCaseBase=c(A,{constructor:function(e){A.call(this,e),this.__setupDatabase__(e)},MAX_CASES_PER_UPSERT:10,__setupDatabase__:function(e){var t=this.Database||require("better-sqlite3");if(e.db instanceof t)this.__db__=e.db;else{var n="string"==typeof e.db?e.db:"./cbr-test.sqlite";this.__db__=new t(n),this.__db__.pragma("journal_mode = OFF"),this.__db__.pragma("cache_size = -128000"),this.__db__.pragma('encoding = "UTF-8"')}this.__tableName__=e.tableName},__createTable__:function(e,t){var n=Object.keys(t.actions).map(function(e){return"a_"+e+" TEXT"}).join(", "),r=Object.keys(t.results).map(function(e){return"won_"+e+" INTEGER, tied_"+e+" INTEGER, lost_"+e+" INTEGER"}).join(", "),s=t.features.map(function(e,t){return"f"+t+" INTEGER"}).join(", ");return this.__runSQL__("CREATE TABLE IF NOT EXISTS "+e+"(id TEXT PRIMARY KEY, count INTEGER, ply REAL, "+n+", "+r+", "+s+")")},__runSQL__:function(e){var t=Array.prototype.slice.call(arguments,1);try{var n=this.__db__.prepare(e);return n.run.apply(n,t)}catch(n){throw new Error("Error executing `"+e+"` "+JSON.stringify(t)+"!")}},__getSQL__:function(e){var t=Array.prototype.slice.call(arguments,1);try{var n=this.__db__.prepare(e);return n.all.apply(n,t)}catch(n){throw new Error("Error querying `"+e+"` "+JSON.stringify(t)+"!")}},init:function(e,t){this.__tableName__=this.__tableName__||"CB_"+e.name;var n=t.casesFromGame(e,0,e.moves())[0];this.__createTable__(this.__tableName__,n)},addCase:function(e){if(Array.isArray(e)||(e=[e]),!(e.length<1)){var t=this,n=t.MAX_CASES_PER_UPSERT,r=e[0].record(),s=Object.keys(r),a=s.filter(function(e){return/^(won_|tied_|lost_)/.test(e)}),i="INSERT INTO "+this.__tableName__+" ("+s.join(",")+") VALUES "+h.repeat("("+h.repeat("?",s.length).join(",")+")",Math.min(e.length,n)).join(",")+" ON CONFLICT(id) DO UPDATE SET count = count + 1, ply = (ply * count + excluded.ply) / (count + 1),  "+a.map(function(e){return e+" = "+e+" + excluded."+e}).join(", ");m(e).slices(n).forEach(function(e){t.__runSQL__(i,m(e).map(function(e){var t=e.record();return s.map(function(e){return t[e]})}).flatten().toArray())})}},cases:function(){return this.__getSQL__("SELECT * FROM "+this.__tableName__).map(E.fromRecord.bind(E))},__nn_sql__:function(e,t){var n=t.map(function(e){return e.features.map(function(e,t){return null===e||isNaN(e)?"0":"abs(ifnull(f"+t+"-("+e+"),0))"}).join("+")});return"SELECT *, "+(n.length>1?n[0]:"min("+n.join(", ")+")")+" AS distance FROM "+this.__tableName__+" ORDER BY distance ASC LIMIT "+e},nn:function(e,t){var n=this.__nn_sql__(e,t);return this.__db__.prepare(n).all().map(function(e){return[E.fromRecord(e),e.distance]})}}),g.TicTacToe=(s=function(e){return("string"==typeof e?e:e.board).split("").map(function(e){return"X"===e?1:"O"===e?-1:0})},a=c(N,{constructor:function(e){N.call(this,e)},game:new r.games.TicTacToe,features:s,casesFromGame:function(e,t,n){var r=n?n.hasOwnProperty("Xs")?n.Xs:n.Os:"?";return[this.newCase(e,t,n,{id:e.board+r,features:this.features(e)})]}}),i=[[0,1,2,3,4,5,6,7,8],[2,1,0,5,4,3,8,7,6],[6,7,8,3,4,5,0,1,2],[6,3,0,7,4,1,8,5,2],[2,5,8,1,4,7,0,3,6],[8,7,6,5,4,3,2,1,0],[8,5,2,7,4,1,6,3,0],[0,3,6,1,4,7,2,5,8]],o=function(e){var t="string"==typeof e?e:e.board,n=i.map(function(e){return e.map(function(e){return t.charAt(e)}).join("")});return(n=Array.from(new Set(n))).sort(),n},u=c(N,{constructor:function(e){N.call(this,e)},game:new r.games.TicTacToe,features:s,MAPPINGS:i,casesFromGame:function(e,t,n){var r=this,s=e.board.split(""),a=e.activePlayer();return n&&(s[n[a]]="!"),o(s.join("")).map(function(e){var t=e.indexOf("!");return e.replace("!","_")+t}).map(function(s){return n&&(n[a]=+s.substr(9)),r.newCase(e,t,n,{features:r.features(s.substr(0,9))})})}}),{directFeatures:s,DirectCBPlayer:a,MAPPINGS:i,equivalent:o,EquivalenceCBPlayer:u}),b.populate=function(e,t){var n=(t=t||{}).game||e.game,s=isNaN(t.n)?100:+t.n,a=t.trainer||e,i=t.opponents||[a];Array.isArray(i)||(i=[i]);var o=new r.tournaments.Measurement(n,a,i,1).__matches__().toArray();return e.addMatches(h.range(Math.ceil(s/o.length)).product(o).mapApply(function(e,t){return new r.Match(n,t.players)}),t)},v.assess=function(e,n){var s=n.opponents||n.opponent?[n.opponent]:new r.players.RandomPlayer,a=n.game||e.game,i=m(s).map(function(e){return[e.name,m(a.players).map(function(e){return[e,[0,0,0]]}).toObject()]}).toObject(),o=n&&+n.assessCount||300,u=0,c=0,l=n.logger;return l&&(c=setInterval(function(){l.info("Assessment finished "+u+" matches.")},n.logTime||3e4)),t.Future.sequence(t.Iterable.range(o).product(s),function(n){var s=n[1],o=t.Iterable.repeat(s,a.players.length).toArray(),c=n[0]%a.players.length,l=a.players[c];o[c]=e;var _=new r.Match(a,o);return _.run().then(function(){var e=_.result()[l];i[s.name][l][e>0?0:e<0?2:1]++,u++})}).then(function(){return clearInterval(c),l&&l.info("Assessment finished "+u+" matches."),i})},v.populateAndAssess=function(e,n){function s(){return new r.players.RandomPlayer({name:"RandomPlayer"})}var a=n.name||e.name,i=n.logger,o=n.game||e.game;return i&&i.info("Assessing "+o.name+" with "+a+"."),i.info("Base line evaluation for "+o.name+" with a random player."),t.Future.sequence(n.opponents||[s()],function(e){return v.assess(s(),{game:o,opponent:e,assessCount:n.assessCount||80,logger:i}).then(function(t){i.info("Against "+e.name+": "+JSON.stringify(t))})}).then(function(){return b.populate(e,{n:n.populateCount||1e3,trainer:n.trainer||s(),logger:i})}).then(function(){return i.info("Evaluating player for "+o.name+" trained with "+a+"."),t.Future.sequence(n.opponents||[s()],function(t){return v.assess(e,{game:o,opponent:t,assessCount:n.assessCount||80,logger:i}).then(function(e){i.info("Against "+t.name+": "+JSON.stringify(e))})})})},d});
//# sourceMappingURL=ludorum-player-cbr.min.js.map